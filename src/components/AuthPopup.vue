<template>
  <div @click="close">
    <i class="fas fa-times auth-close"></i>
    <div id="authorization" v-if="state === 'auth'">
      <div class="authorization-wrap">
        <div class="container">
          <router-link to="/">
            <svg
              class="login-logo"
              width="172"
              height="36"
              viewBox="0 0 172 36"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12.9605 35C12.0939 35 11.6605 34.5583 11.6605 33.675V22.55L0.460547 4.85C0.0105469 4.13333 0.152214 3.525 0.885547 3.025C1.63555 2.55833 2.24388 2.7 2.71055 3.45L12.9605 19.725L23.3855 3.425C23.6189 3.075 23.8855 2.86667 24.1855 2.8C24.4855 2.73333 24.8189 2.81666 25.1855 3.05C25.9355 3.5 26.0689 4.1 25.5855 4.85L14.2855 22.55V33.675C14.2855 34.5583 13.8439 35 12.9605 35ZM34.607 35C31.4904 35 29.207 34.2833 27.757 32.85C26.307 31.4 25.582 29.125 25.582 26.025V20.375C25.582 17.225 26.307 14.9333 27.757 13.5C29.207 12.05 31.4904 11.3417 34.607 11.375H38.707C41.8237 11.375 44.0987 12.1 45.532 13.55C46.982 14.9833 47.707 17.2583 47.707 20.375V25.975C47.707 29.0917 46.982 31.375 45.532 32.825C44.0987 34.275 41.8237 35 38.707 35H34.607ZM28.207 26.025C28.207 28.375 28.6737 30.025 29.607 30.975C30.557 31.9083 32.2237 32.375 34.607 32.375H38.707C41.0904 32.375 42.7487 31.9083 43.682 30.975C44.6154 30.025 45.082 28.3583 45.082 25.975V20.375C45.082 17.9917 44.6154 16.3333 43.682 15.4C42.7487 14.4667 41.0904 14 38.707 14H34.607C33.007 13.9833 31.7404 14.175 30.807 14.575C29.8737 14.975 29.207 15.6417 28.807 16.575C28.407 17.5083 28.207 18.775 28.207 20.375V26.025ZM76.234 11.375C77.1173 11.375 77.559 11.8167 77.559 12.7V33.7C77.559 34.5667 77.1173 35 76.234 35C75.3673 35 74.934 34.5667 74.934 33.7V31.3C73.3507 33.7667 70.484 35 66.334 35H64.934C61.8173 35 59.534 34.2833 58.084 32.85C56.6507 31.4 55.934 29.1167 55.934 26V12.7C55.934 11.8167 56.3673 11.375 57.234 11.375C58.1173 11.375 58.559 11.8167 58.559 12.7V26C58.559 28.3833 59.0257 30.0417 59.959 30.975C60.909 31.9083 62.5673 32.375 64.934 32.375H66.334C68.9173 32.375 70.9507 31.9667 72.434 31.15C73.9173 30.3333 74.7507 29.0583 74.934 27.325V12.7C74.934 11.8167 75.3673 11.375 76.234 11.375ZM88.2266 35C87.3432 35 86.9016 34.5583 86.9016 33.675V4.1C86.9016 3.21667 87.3432 2.775 88.2266 2.775H106.252C106.668 2.775 106.985 2.89167 107.202 3.125C107.435 3.34166 107.552 3.66666 107.552 4.1C107.552 4.96667 107.118 5.4 106.252 5.4H89.5266V17.375H100.927C101.81 17.375 102.252 17.8083 102.252 18.675C102.252 19.5583 101.81 20 100.927 20H89.5266V33.675C89.5266 34.5583 89.0932 35 88.2266 35ZM113.568 35C112.685 35 112.243 34.5583 112.243 33.675V12.675C112.243 11.8083 112.685 11.375 113.568 11.375C114.435 11.375 114.868 11.8083 114.868 12.675V33.675C114.868 34.5583 114.435 35 113.568 35ZM113.018 6.8C111.868 6.8 111.293 6.20833 111.293 5.025V3.9C111.293 2.76667 111.868 2.2 113.018 2.2H114.118C115.252 2.2 115.818 2.76667 115.818 3.9V5.025C115.818 6.20833 115.252 6.8 114.118 6.8H113.018ZM131.081 35C128.715 35 126.973 34.45 125.856 33.35C124.756 32.25 124.206 30.525 124.206 28.175V1.625C124.206 0.758332 124.648 0.324998 125.531 0.324998C126.398 0.324998 126.831 0.758332 126.831 1.625V28.175C126.831 29.7917 127.131 30.9 127.731 31.5C128.331 32.0833 129.44 32.375 131.056 32.375C131.956 32.375 132.406 32.8083 132.406 33.675C132.423 34.5583 131.981 35 131.081 35ZM163.718 11.325C166.402 11.325 168.318 12.0083 169.468 13.375C170.635 14.7417 171.218 17 171.218 20.15V33.725C171.218 34.5917 170.785 35.025 169.918 35.025C169.035 35.025 168.593 34.5917 168.593 33.725V20.15C168.593 17.95 168.218 16.3667 167.468 15.4C166.718 14.4333 165.468 13.95 163.718 13.95H161.643C159.46 13.95 157.893 14.4333 156.943 15.4C156.01 16.3667 155.543 17.95 155.543 20.15V33.725C155.543 34.5917 155.11 35.025 154.243 35.025C153.36 35.025 152.918 34.5917 152.918 33.725V20.15C152.918 17.95 152.543 16.3667 151.793 15.4C151.043 14.4333 149.793 13.95 148.043 13.95H145.968C143.785 13.95 142.218 14.4333 141.268 15.4C140.335 16.3667 139.868 17.95 139.868 20.15V33.725C139.868 34.5917 139.435 35.025 138.568 35.025C137.685 35.025 137.243 34.5917 137.243 33.725V12.675C137.243 11.8083 137.685 11.375 138.568 11.375C139.435 11.375 139.868 11.8083 139.868 12.675V14.625C140.602 13.4417 141.468 12.6 142.468 12.1C143.485 11.5833 144.768 11.325 146.318 11.325H148.043C149.793 11.325 151.193 11.6333 152.243 12.25C153.31 12.85 154.152 13.8417 154.768 15.225C155.502 13.8417 156.402 12.85 157.468 12.25C158.535 11.6333 159.927 11.325 161.643 11.325H163.718Z"
                fill="#C6A564"
              />
            </svg>
          </router-link>
          <form
            class="authorization-text--wrap"
            ref="loginForm"
            @submit.prevent="loginUser"
          >
            <input 
              type="email"
              v-model="email" 
              placeholder="E-mail"
              :class="{'errorIn': ($v.email.$dirty && !$v.email.required) || ($v.email.$dirty && !$v.email.email)}" />
            <small
              class="errorIn form-text"
              v-if="$v.email.$dirty && !$v.email.required"
            >
              Введіть свій Email
            </small>
            <small
              class="errorIn form-text"
              v-else-if="$v.email.$dirty && !$v.email.email"
            >
              Приклад: email@gmail.com
            </small>
            <input 
              type="password" 
              v-model="password" 
              placeholder="Пароль"
              :class="{'errorIn' : $v.password.$dirty && !$v.password.required}" />
            <small
              class="errorIn form-text"
              v-if="$v.password.$dirty && !$v.password.required"
            >
              Введіть пароль
            </small>
            <p class="forgetPass" @click.prevent=forgetPassword>Не пам'ятаю пароль</p>
            <button>Увійти</button>
            <span class="login-account" @click="goToRegister"
              >Немає аккаунту? Зареєструйся!</span
            >
          </form>
        </div>
      </div>
    </div>
    <div id="login" v-else-if="state === 'login'">
      <div class="login-wrap">
        <div class="container">
          <router-link to="/">
            <svg
              class="login-logo"
              width="172"
              height="36"
              viewBox="0 0 172 36"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12.9605 35C12.0939 35 11.6605 34.5583 11.6605 33.675V22.55L0.460547 4.85C0.0105469 4.13333 0.152214 3.525 0.885547 3.025C1.63555 2.55833 2.24388 2.7 2.71055 3.45L12.9605 19.725L23.3855 3.425C23.6189 3.075 23.8855 2.86667 24.1855 2.8C24.4855 2.73333 24.8189 2.81666 25.1855 3.05C25.9355 3.5 26.0689 4.1 25.5855 4.85L14.2855 22.55V33.675C14.2855 34.5583 13.8439 35 12.9605 35ZM34.607 35C31.4904 35 29.207 34.2833 27.757 32.85C26.307 31.4 25.582 29.125 25.582 26.025V20.375C25.582 17.225 26.307 14.9333 27.757 13.5C29.207 12.05 31.4904 11.3417 34.607 11.375H38.707C41.8237 11.375 44.0987 12.1 45.532 13.55C46.982 14.9833 47.707 17.2583 47.707 20.375V25.975C47.707 29.0917 46.982 31.375 45.532 32.825C44.0987 34.275 41.8237 35 38.707 35H34.607ZM28.207 26.025C28.207 28.375 28.6737 30.025 29.607 30.975C30.557 31.9083 32.2237 32.375 34.607 32.375H38.707C41.0904 32.375 42.7487 31.9083 43.682 30.975C44.6154 30.025 45.082 28.3583 45.082 25.975V20.375C45.082 17.9917 44.6154 16.3333 43.682 15.4C42.7487 14.4667 41.0904 14 38.707 14H34.607C33.007 13.9833 31.7404 14.175 30.807 14.575C29.8737 14.975 29.207 15.6417 28.807 16.575C28.407 17.5083 28.207 18.775 28.207 20.375V26.025ZM76.234 11.375C77.1173 11.375 77.559 11.8167 77.559 12.7V33.7C77.559 34.5667 77.1173 35 76.234 35C75.3673 35 74.934 34.5667 74.934 33.7V31.3C73.3507 33.7667 70.484 35 66.334 35H64.934C61.8173 35 59.534 34.2833 58.084 32.85C56.6507 31.4 55.934 29.1167 55.934 26V12.7C55.934 11.8167 56.3673 11.375 57.234 11.375C58.1173 11.375 58.559 11.8167 58.559 12.7V26C58.559 28.3833 59.0257 30.0417 59.959 30.975C60.909 31.9083 62.5673 32.375 64.934 32.375H66.334C68.9173 32.375 70.9507 31.9667 72.434 31.15C73.9173 30.3333 74.7507 29.0583 74.934 27.325V12.7C74.934 11.8167 75.3673 11.375 76.234 11.375ZM88.2266 35C87.3432 35 86.9016 34.5583 86.9016 33.675V4.1C86.9016 3.21667 87.3432 2.775 88.2266 2.775H106.252C106.668 2.775 106.985 2.89167 107.202 3.125C107.435 3.34166 107.552 3.66666 107.552 4.1C107.552 4.96667 107.118 5.4 106.252 5.4H89.5266V17.375H100.927C101.81 17.375 102.252 17.8083 102.252 18.675C102.252 19.5583 101.81 20 100.927 20H89.5266V33.675C89.5266 34.5583 89.0932 35 88.2266 35ZM113.568 35C112.685 35 112.243 34.5583 112.243 33.675V12.675C112.243 11.8083 112.685 11.375 113.568 11.375C114.435 11.375 114.868 11.8083 114.868 12.675V33.675C114.868 34.5583 114.435 35 113.568 35ZM113.018 6.8C111.868 6.8 111.293 6.20833 111.293 5.025V3.9C111.293 2.76667 111.868 2.2 113.018 2.2H114.118C115.252 2.2 115.818 2.76667 115.818 3.9V5.025C115.818 6.20833 115.252 6.8 114.118 6.8H113.018ZM131.081 35C128.715 35 126.973 34.45 125.856 33.35C124.756 32.25 124.206 30.525 124.206 28.175V1.625C124.206 0.758332 124.648 0.324998 125.531 0.324998C126.398 0.324998 126.831 0.758332 126.831 1.625V28.175C126.831 29.7917 127.131 30.9 127.731 31.5C128.331 32.0833 129.44 32.375 131.056 32.375C131.956 32.375 132.406 32.8083 132.406 33.675C132.423 34.5583 131.981 35 131.081 35ZM163.718 11.325C166.402 11.325 168.318 12.0083 169.468 13.375C170.635 14.7417 171.218 17 171.218 20.15V33.725C171.218 34.5917 170.785 35.025 169.918 35.025C169.035 35.025 168.593 34.5917 168.593 33.725V20.15C168.593 17.95 168.218 16.3667 167.468 15.4C166.718 14.4333 165.468 13.95 163.718 13.95H161.643C159.46 13.95 157.893 14.4333 156.943 15.4C156.01 16.3667 155.543 17.95 155.543 20.15V33.725C155.543 34.5917 155.11 35.025 154.243 35.025C153.36 35.025 152.918 34.5917 152.918 33.725V20.15C152.918 17.95 152.543 16.3667 151.793 15.4C151.043 14.4333 149.793 13.95 148.043 13.95H145.968C143.785 13.95 142.218 14.4333 141.268 15.4C140.335 16.3667 139.868 17.95 139.868 20.15V33.725C139.868 34.5917 139.435 35.025 138.568 35.025C137.685 35.025 137.243 34.5917 137.243 33.725V12.675C137.243 11.8083 137.685 11.375 138.568 11.375C139.435 11.375 139.868 11.8083 139.868 12.675V14.625C140.602 13.4417 141.468 12.6 142.468 12.1C143.485 11.5833 144.768 11.325 146.318 11.325H148.043C149.793 11.325 151.193 11.6333 152.243 12.25C153.31 12.85 154.152 13.8417 154.768 15.225C155.502 13.8417 156.402 12.85 157.468 12.25C158.535 11.6333 159.927 11.325 161.643 11.325H163.718Z"
                fill="#C6A564"
              />
            </svg>
          </router-link>
          <div class="login-text--wrap">
            <span @click="goToRegister" class="login-register">Реєстрація</span>
            <p class="login-or">Або</p>
            <a href="#" class="login-google"
              >Увійти через <span>Google</span></a
            >
            <span class="login-account" ref="haveAccountLink">
              у мене вже є аккаунт
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { email, required, minLength } from "vuelidate/lib/validators"
import messages from '@/utils/messages'

export default {
  props: ["isVisible"],
  data: () => ({
    state: "auth",
    email: '',
    password: '',
  }),
  validations: {
    email: { email, required },
    password: { required },
  },
  methods: {
    changeState(state) {
      this.state = state;
    },
    goToRegister() {
      this.$emit("closeAuth");
      this.$router.push("/register");
    },
    async loginUser() {
      if(this.$v.$invalid) {
        this.$v.$touch()
        return
      }
      const formData = {
        email: this.email,
        password: this.password,
      };

      try {
        await this.$store.dispatch("login", formData);
        this.$router.push("/profile");
        this.$emit("closeAuth");
      } catch (e) {
        if (e.code !== 'auth/wrong-password') {
          this.email = ''
        }
        this.password = ''
        this.$v.$reset()
        this.$message(messages[e.code])
      }
    },
    close(e) {
      if (e.target == this.$refs.haveAccountLink) {
        this.state = "auth";
      } else if (
        this.$refs.loginForm &&
        (e.target == this.$refs.loginForm ||
          this.$refs.loginForm.contains(e.target))
      ) {
        return;
      } else {
        this.$emit("closeAuth");
      }
    },
  },
};
</script>


